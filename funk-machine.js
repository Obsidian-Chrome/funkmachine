// Lyrics Database
const lyricsDatabase = {
    "Let's Funk Tonight": `[Intro]
Mmm… yeah baby, don't get it twisted.
I said funk — but you know what I mean.
Turn the lights down… let that bass breathe.

[Verse 1]
Got that rhythm creepin' under my skin,
Feelin' that fever, it's about to begin.
Silk and sweat, candlelight glow,
The way you move — I already know.

You talk sweet but your eyes say "go,"
Body's hummin' like a radio.
No need to rush, no need to fight,
Just come a little closer, we'll funk tonight.

[Pre-Chorus]
Ooh, the groove's so tight,
We're burnin' low but feelin' right.
Don't stop, don't think — just ride the line,
You bring the spark, I'll bring the shine.

[Chorus]
Let's funk tonight! (Yeah, baby, don't stop!)
Let's funk tonight! (Get down, don't drop!)
We don't need words, we don't need light,
When I say funk, I mean all night.

[Verse 2]
You said "Be gentle," I said "I might,"
But the groove got strong and the bass got tight.
Sweat drippin' slow, heartbeat loud,
We're makin' magic that can't be proud.

You move like thunder, I move like flame,
Every breath just feeds the game.
Ain't no shame in what we do,
Just the funk, me and you.

[Bridge]
(F-f-f-funk me, baby…)
Slide to the rhythm, bend with the beat,
Let the funk take over your feet.
We don't curse, we don't fight,
We just make love to the sound tonight.

[Chorus]
Let's funk tonight! (Ooooh, come on, yeah!)
Let's funk tonight! (Show me that flair!)
Let the groove talk dirty, the rhythm bite,
We're innocent — but not quite.

[Outro]
Yeah… that's the sound.
You feel it in your bones, baby.
That's the power of the funk.
Clean on the tongue…
Dirty on the mind.
Now… let's funk tonight.`,
    "Where's His Left Arm": `[Verse 1]
Raubahn’s walkin’ down the avenue,
Golden grin, them ladies sayin’ “whoo!”
Got that swagger, got that flame,
They whisper low, “we know your name…”

He’s the general of style, a desert king,
Every move he makes got that funky swing.
They slide him notes, oh, temptations rise,
But Raubahn just smiles with those tired eyes.

[Pre-Chorus]
“Oh sugar, don’t tease me slow,
I’ve fought my wars, now I just want to glow…”

[Chorus]
Where’s his left arm? (Tell me now!)
Where’s his left arm? (Come on, wow!)
He lost it long ago in a holy fight—
But baby, maybe, he’s usin’ it tonight…

[Verse 2]
They call him the Bull of the Sands, oh yeah,
He’s got one hand, but a whole lotta flair.
Women whisperin’ in moonlit halls,
"One arm’s gone, but he still stands tall."

They offer silk, wine, and sin,
Sayin’, “Raubahn, let the night begin.”
He just laughs, adjusts his coat,
Says, “Careful, darling, I ain’t remote.”

[Pre-Chorus]
“Now don’t you worry ‘bout the arm I lack,
‘Cause I got other ways to get you back…”

[Chorus]
Where’s his left arm? (Say it loud!)
Where’s his left arm? (Funk the crowd!)
He lost it once, but baby hold on tight—
We all know where it went tonight.

[Bridge]
Yeah… Raubahn don’t need no prosthetic, baby.
He’s multi-talented.
That missing limb?
It’s on a mission… deep undercover.
You dig?

[Final Chorus]
Where’s his left arm? (Shake it, babe!)
Where’s his left arm? (Mmm, behave!)
He’s a one-armed man, but he’s doin’ it right—
Now we all know where it’s stuck tonight…

[Outro]
Funky Raubahn…
Keep it classy, keep it wild…
Left arm or not, he’s got the style.`,
    "Gold Saucer": `[Intro]
Mmm… Step inside, baby.
Golden lights, glitter nights…
You came to play? Or you came to funk?

[Verse 1]
Lights are flashin’, wheels are spinnin’,
Gils are flyin’, hearts are sinnin’.
Cactuars winkin’ from the floor,
You bet your luck — and maybe more.

That dancer’s movin’, got that sway,
Chocobos racin’, crowds go cray.
Triple Triad, spin that card,
But the way you move is hittin’ hard.

[Pre-Chorus]
No need for chips, no need for fame,
This kind of play’s a private game.
You roll your dice, I’ll play my hand,
Let’s make a jackpot you can’t withstand!

[Chorus]
We’re gonna funk in the Gold Saucer tonight!
(Oh yeah, baby, neon light!)
Spinnin’ reels and feelin’ right,
When the groove hits, hold on tight!

We’re gonna funk in the Gold Saucer tonight!
(Deal that soul, raise that bet!)
It’s the hottest game you’ll never forget —
When we funk in the Gold Saucer tonight!

[Verse 2]
You said, “Careful, this ain’t free,”
I said, “Girl, the house can’t handle me.”
You flash that smile, I lose control,
Your eyes are the prize — and I’m on a roll.

Slot machines hummin’ deep in tune,
Body heat risin’ under the moon.
I play my cards close to the chest,
But you can tell I’m feelin’ blessed.

[Bridge]
(F-f-f-funk me, baby… jackpot!)
We’re dancin’ high on that crystal light,
Every step a sin in sight.
Lady Luck don’t need no dice,
Just a groove that feels so nice.

[Chorus]
We’re gonna funk in the Gold Saucer tonight!
(Ooh yeah, don’t stop the light!)
Let the bass roll, spin that fate,
You can’t leave now — it’s far too late.

We’re gonna funk in the Gold Saucer tonight!
(Sweet temptation, hold on tight!)
Win or lose, it’s all the same,
‘Cause baby, funk’s my favorite game.

[Outro]
Yeah… lights go down…
Crowds fade out…
Just you, me, and the sound.
Forget the gils, forget the fame…
You came to play,
But you stayed for the funk.`,
    "Garlond Groove": `[Intro]
Pssshh… clank, clank...
Oh, baby — hear that hum?
That’s not a machine… that’s desire.
Time to get your hands greasy.

[Verse 1]
Steam’s risin’ up from the floor,
You walk in — and I want more.
Chrome and leather, sparks in flight,
Gonna tune you up just right tonight.

Got them tools lined side by side,
You twist that wrench, I lose my pride.
You say “Tighten me, don’t be shy,”
I say “Baby, I’ll make your engine cry.”

[Pre-Chorus]
Heat and pressure, metal and skin,
Let that rhythm pull you in.
Ain’t no oil can stop this drive,
We’re runnin’ hot, we’re feelin’ alive!

[Chorus]
Garlond groove, turn the gears tonight!
Spark that fire, make the pistons fight!
Steam and sweat, hearts in line,
Baby, feel that Garlond grind!

Garlond groove, keep that motion tight!
Bolt me down, let the torque ignite!
Steel and soul, perfectly combined —
That’s the sound of a dirty mind.

[Verse 2]
Your gloves are off, your hands are slick,
You flip that switch — oh, that’s the trick.
The motor hums, the pressure grows,
You say, “Rev it up,” and the whole shop glows.

Gears are grinding, belts are tight,
Every spark a touch of light.
You whisper low, “I need that spin,”
I say, “Let’s start the engine again.”

[Bridge]
(F-f-f-funk that metal, baby…)
Turn that screw, adjust that line,
Let the current cross the spine.
We’re wired deep, we’re built to last,
That Garlond groove will kick your ass.

[Chorus]
Garlond groove, turn the gears tonight!
Steam me up under the neon light!
Heat’s risin’, can’t unwind,
Baby, we’re forged and intertwined!

Garlond groove, one more time!
Pistons poundin’ to that funky rhyme!
Steel hearts welded, you and me —
Built for love and machinery!

[Outro]
Mmm… yeah…
Pressure’s low, but the heat’s still there.
That’s what I call good maintenance.
Next tune-up’s on me, baby.
Keep it tight… and keep it funky.`,
    "Mist 9": `[Intro]
Mmm… Mist Nine, baby…
Where the sand still shines after the storm.
You feel that?
It’s not just the heat… it’s the groove.

[Verse 1]
Down by the shore where the waves roll slow,
Sun still burnin’ with a lazy glow.
People laughin’, barefoot dreams,
Music spillin’ out in steamy streams.

Palms keep swayin’, hips in time,
Sweat and rain in a salty rhyme.
You catch a smile, hearts collide,
That’s how it starts down in Mist Nine.

[Pre-Chorus]
Raindrops fall, but no one cares,
We’re dancin’ wild in open air.
The night’s alive, the sky’s a flame,
Nobody leaves the way they came.

[Chorus]
Mist Nine, hot and wet,
Best damn night you’ll ever get!
Bodies glow in silver light,
Oh baby, it feels so right!
Mist Nine, sweat and rain,
Can’t tell pleasure from the pain!

[Verse 2]
Beachside bar, music loud,
Every beat electrifies the crowd.
She moves close, drops that line,
“Baby, let’s lose track of time.”

The air is thick, her skin’s divine,
Drops of rain like sweet red wine.
Thunder hums, hearts entwine,
You can taste the heat of Mist Nine.

[Bridge]
The sky’s cryin’, but the funk won’t fade,
We’re soaked in rhythm that the ocean made.
Every wave a breath, every sigh a spark,
Mist Nine’s where the fire meets the dark.

Ooh, don’t stop, let it slide,
Rain or shine, we’ll ride that vibe!

[Chorus]
Mist Nine, hot and wet,
Can’t forget the groove we met!
Rain on skin, hearts ignite,
We’re still burnin’ through the night!
Mist Nine, sweet design,
Turn the storm to paradise!

[Outro]
Mmm…
When the morning comes, the sand still shines.
The rain’s gone, but the heat’s still mine.
If you ever lose your mind…
You’ll find it back in Mist Nine.`,
    "Alys In Blue": `[Intro]
Mmm…
You see that woman over there?
Blue hair, hips like rhythm itself…
That’s Alys.
And I’m about to lose control.

[Verse 1]
Alys walkin’ in with that midnight sway,
Every step she takes, the lights obey.
Skin like honey, hair like the sea,
Every eye’s on her — but she’s lookin’ at me.

She smiles slow, the room gets warm,
Every curve’s a perfect storm.
She said, “You think you can handle this view?”
I said, “Girl, I was born to funk with you.”

[Pre-Chorus]
She’s got that power, that sugar, that flame,
I’m losin’ my cool, forgettin’ my name.
The air is thick, the groove is tight,
And I’m prayin’ she stays all night.

[Chorus]
Alys in blue, what you wanna do?
Your body’s singin’ like a love tattoo.
I don’t need magic, don’t need a clue,
I just need the funk — and you.

Alys in blue, turn that gaze my way,
Let the rhythm talk, let the bassline play.
Every move’s got somethin’ new,
I’m fallin’, baby, deep into you.

[Verse 2]
She leans close, whispers “Dance with me,”
The floor’s on fire, can’t you see?
Her perfume’s got that electric bite,
And the whole damn world feels right.

Hands on hips, hearts in sync,
Sweat and groove, no time to think.
She says, “You talk too much, just move,”
And baby — I let the rhythm prove.

[Bridge]
(F-f-f-funk me, Alys…)
Blue light on your skin,
The night’s where we begin.
No words, just the truth,
Let me drown in your groove.

[Chorus]
Alys in blue, what you gonna do?
You got me spellbound, dreamin’ of you.
Under that moon, under that hue,
I’m a slave to your funk, it’s true.

Alys in blue, keep that fire alive,
You’re the beat that makes me thrive.
Every sigh, every view —
Is funk, pure funk, and you.

[Outro]
Yeah…
Alys, don’t walk away,
The night’s still young, the groove still plays.
Blue hair, brown eyes, sweet perfume…
You turned the dance floor into a bedroom.`,
    "I'm the Fun in Funk": `[Intro]
Uh! Yeah!
You feel that groove?
Well baby, that's me —
I'm the fun in funk!

[Verse 1]
Step aside, I'm comin' through,
Bass in hand, got that shine on my shoe.
You talk cool, but I walk groove,
Every beat I drop makes your body move!

Feelin' fine, I turn it up high,
Sweat and rhythm, we electrify!
Got no rules, I got no plan,
Just a funky heart and a mic in my hand!

[Pre-Chorus]
Slide to the left, shake it to the right,
We don't stop till the morning light!
No time for chill, no time for junk —
I'm the soul, the sound, the funk!

[Chorus]
I'm the fun in funk, the kick in the beat!
The fire in your soul and the groove in your feet!
When I hit that stage, it's a funky crime —
I'm the fun in funk, baby, every time!

[Verse 2]
Slick shades on, got a disco smile,
Turnin' every crowd into a fever file.
My bass don't lie, it tells the truth —
If it don't move your hips, it's uncouth!

Can you feel it? That funky flame?
It's callin' your name in neon rain.
The night's alive, we don't come down —
We own this city, we funk this town!

[Bridge]
F-U-N-K — say my name!
Doctor groove in the hall of fame!
Raise your hands, let the rhythm flow,
Funk Machine's here — now you know!

Got the slap, got the soul, got that shine —
You bring the crowd, I'll bring the line!

[Chorus]
I'm the fun in funk, the bass in your bones!
The spark in your heart and the heat in your tones!
I'm the beat that breaks your chains apart —
The fun in funk, baby, straight from the heart!

[Outro]
Uh!
Don't forget my name when the lights go out —
Funk Machine, baby, that's what I'm about!
You bring the night, I bring the junk —
'Cause I'm the fun… in FUNK!`,
    "The Groove Protocol": `[Intro]
"Attention, citizens of Neon City…
The beat has been compromised.
Initiating recovery sequence —
The Groove Protocol is now in effect."

[Verse 1]
Too many people livin' outta sync,
Cold machines, they forgot how to think.
No pulse, no rhythm in their soul,
But I'm the doc — and I'm takin' control.

Plug in your heart, let me realign,
Reboot your soul to the tempo divine.
I got the bassline, hot and illegal,
Welcome to the Groove Cathedral!

[Pre-Chorus]
You can't fake it, can't deny,
Once the funk hits, you testify.
The system shakes, the lights go wild,
Protocol's active — and you're beguiled!

[Chorus]
It's The Groove Protocol — feel the code ignite,
From your head to your hips, let your body rewrite!
Neon sparks and the bass explode,
We're uploadin' funk — overload!

It's The Groove Protocol — break the rule of cool,
Get loud, get hot, let the rhythm rule!
No resistance, no control,
Let the funk take your soul!

[Verse 2]
Wires hummin', lights turn blue,
Every move I make's electric too.
Your data's dirty, but I don't mind,
I clean corruption — one groove at a time.

Bass so deep it shakes the core,
Funk Machine's knockin' at your door.
No firewall can keep me back,
'Cause the groove's my coded attack!

[Bridge]
"Funk is the law.
Rhythm is the order.
Obey the bass.
Dance... or be deleted."

[Final Chorus]
It's The Groove Protocol — global sync tonight,
Upload your body, download the light!
Bassline burnin', system overload,
Funk Machine online, in full node!

It's The Groove Protocol — let the night unfold,
Turn up the heat, melt the cold!
No escape, no control —
You're now part of the Groove Protocol!

[Outro]
"Transmission complete…
Patient stabilized.
Funk restored.
End of file — Groove Protocol."`,
    "The Surgeon": `[Intro]
Yeah...
They call me The Surgeon.
'Cause when the groove is sick...
I make it bleed funk.

[Verse 1]
Step in the room, white coat, gold chain,
Bass in my hand, I'm the cure for your pain.
Heartbeat's jumpin', rhythm flatlined,
Scalpel in the mix — now watch it come alive!

Midnight fever, sweat on the floor,
I slice that groove, you beg for more.
No anesthesia, I work it raw,
Doctor of funk with a disco law!

[Pre-Chorus]
I don't do mercy, baby, I do bass,
One clean cut and I'll fix your face.
You want rhythm? I'll give you some —
Step right up, let me numb your drum!

[Chorus]
They call me The Surgeon, I cut the beat clean,
Slice through the silence, make the rhythm scream!
Funk Machine's in the house tonight,
Operating till the groove feels right!

[Verse 2]
Sharpen my strings, sterilize that tone,
Every bassline's carved to the bone.
Bring me a patient with no soul left,
I'll funk 'em up till there's nothing left!

Neon City glows, hearts on the wire,
I groove precise, I feed the fire.
From uptown haze to the midnight docks,
Everybody knows — it's Funk Machine o'clock!

[Bridge]
Doctor! Doctor! Can you feel that funk?
Give me rhythm! Make it stunk!

Scalpel... bassline... incision clean,
Open the groove, insert the machine!
BPM's risin', heart's on fire,
I'm the Surgeon — pure desire!

[Final Chorus]
They call me The Surgeon, ruler of the groove,
Cut so deep, you can't help but move!
Basslines burnin', lights ignite,
Healin' souls with funk tonight!

They call me The Surgeon, sound so mean,
Funk so tight, it's medically clean!
Funk Machine, yeah, I'm the cure —
Once you taste the groove, you'll want more!

[Outro]
Scalpel down… mission complete.
Another night saved by the beat.
Name's Funk Machine — The Surgeon.
And baby… the operation was perfectly funky.`,
    "Neon Sunrise": `[Intro]
The city's still humming,
Last beat fading slow…
Lights turn to gold,
And I can feel it — the afterglow.

[Verse 1]
There's glitter on the sidewalk,
And rhythm in the air,
Every soul that danced tonight
Left a little groove somewhere.

My bass is tired but smiling,
She knows the night was true,
We fed the heart of Neon City,
Now she's shining new.

[Pre-Chorus]
The streets are quiet, but my pulse still flies,
The funk don't sleep, it just close its eyes.
Another dawn, another flame,
The groove remains — it knows my name.

[Chorus]
Neon Sunrise — painting dreams in light,
The funk fades slow, but it feels so right.
Every beat we played, every heart we moved,
Still echoes on... yeah, the city's proof.

Neon Sunrise — warmth on chrome,
Wherever I go, the groove's my home.

[Verse 2]
Last lovers leaving the dancefloor slow,
Eyes half-closed, still in the glow.
Talkbox whispers, machines at rest,
The Doc retires — he did his best.

And somewhere deep, beneath the sound,
A pulse keeps moving underground.
'Cause funk's a fire that never dies,
It just hides behind the sunrise.

[Bridge]

[Final Chorus]
Neon Sunrise — the night's last kiss,
The groove is gone, but I still feel bliss.
Let the morning find my song,
Funk Machine's heart beats on and on.

[Outro]
The lights fade out…
but the rhythm stays.
Another night, another city —
same funk, new rays.

Funk… Machiiiiiine…`
};

// Player State
const player = {
    audio: document.getElementById('audioPlayer'),
    currentTrackIndex: -1,
    isPlaying: false,
    isShuffle: false,
    repeatMode: 0, // 0: no repeat, 1: repeat all, 2: repeat one
    volume: 0.7,
    tracks: []
};

// DOM Elements
const playBtn = document.getElementById('playBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const repeatBtn = document.getElementById('repeatBtn');
const volumeBtn = document.getElementById('volumeBtn');
const volumeSlider = document.getElementById('volumeSlider');
const volumeFill = document.getElementById('volumeFill');
const progressBar = document.getElementById('progressBar');
const progressFill = document.getElementById('progressFill');
const progressHandle = document.getElementById('progressHandle');
const currentTime = document.getElementById('currentTime');
const totalTime = document.getElementById('totalTime');
const currentTrackName = document.getElementById('currentTrackName');
const playlist = document.getElementById('playlist');
const trackItems = document.querySelectorAll('.track-item');
const lyricsContainer = document.getElementById('lyricsContainer');
const lyricsToggleBtn = document.getElementById('lyricsToggleBtn');
const lyricsContent = document.getElementById('lyricsContent');
const lyricsHint = document.getElementById('lyricsHint');

// Initialize
function init() {
    // Get all tracks
    trackItems.forEach((item, index) => {
        player.tracks.push({
            element: item,
            src: item.dataset.src,
            name: item.querySelector('.track-name').textContent,
            duration: item.querySelector('.track-duration').textContent
        });
        
        // Add click event
        item.addEventListener('click', (e) => {
            // Don't load track if clicking on download or YouTube button
            if (e.target.closest('.track-download-btn') || e.target.closest('.track-youtube-btn')) {
                return;
            }
            loadTrack(index);
        });
    });
    
    // Prevent download and YouTube buttons from triggering track load
    document.querySelectorAll('.track-download-btn, .track-youtube-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    });
    
    // Set initial volume
    player.audio.volume = player.volume;
    updateVolumeUI();
    
    // Event Listeners
    playBtn.addEventListener('click', togglePlay);
    prevBtn.addEventListener('click', playPrevious);
    nextBtn.addEventListener('click', playNext);
    shuffleBtn.addEventListener('click', toggleShuffle);
    repeatBtn.addEventListener('click', toggleRepeat);
    volumeBtn.addEventListener('click', toggleMute);
    volumeSlider.addEventListener('input', changeVolume);
    progressBar.addEventListener('click', seek);
    
    // Audio Events
    player.audio.addEventListener('timeupdate', updateProgress);
    player.audio.addEventListener('loadedmetadata', updateDuration);
    player.audio.addEventListener('ended', handleTrackEnd);
    
    // Lyrics toggle
    lyricsToggleBtn.addEventListener('click', toggleLyrics);
    
    // Keyboard shortcuts
    document.addEventListener('keydown', handleKeyboard);
}

// Load Track
function loadTrack(index) {
    if (index < 0 || index >= player.tracks.length) return;
    
    const track = player.tracks[index];
    player.currentTrackIndex = index;
    
    // Update UI
    trackItems.forEach(item => item.classList.remove('active'));
    track.element.classList.add('active');
    
    currentTrackName.textContent = track.name;
    
    // Update lyrics
    updateLyrics(track.name);
    
    // Load audio
    player.audio.src = track.src;
    player.audio.load();
    
    // Auto play automatically when selecting a track
    player.audio.play().then(() => {
        player.isPlaying = true;
        updatePlayButton();
    }).catch(err => console.log('Playback error:', err));
}

// Update Lyrics
function updateLyrics(trackName) {
    const lyrics = lyricsDatabase[trackName];
    
    if (lyrics) {
        // Hide hint and show lyrics
        lyricsHint.style.display = 'none';
        // Format lyrics with section headers
        const formattedLyrics = lyrics.replace(/\[([^\]]+)\]/g, '<strong>[$1]</strong>');
        lyricsContent.innerHTML = `<div class="lyrics-text">${formattedLyrics}</div>`;
    } else {
        lyricsHint.style.display = 'none';
        lyricsContent.innerHTML = '<p class="lyrics-placeholder">Paroles non disponibles pour cette piste</p>';
    }
}

// Toggle Lyrics
function toggleLyrics() {
    lyricsContainer.classList.toggle('collapsed');
}

// Toggle Play/Pause
function togglePlay() {
    if (player.currentTrackIndex === -1 && player.tracks.length > 0) {
        loadTrack(0);
    }
    
    if (player.isPlaying) {
        player.audio.pause();
        player.isPlaying = false;
        updatePlayButton();
    } else {
        player.audio.play().then(() => {
            player.isPlaying = true;
            updatePlayButton();
        }).catch(err => {
            console.log('Playback error:', err);
        });
    }
}

// Update Play Button
function updatePlayButton() {
    const playIcon = playBtn.querySelector('.play-icon');
    const pauseIcon = playBtn.querySelector('.pause-icon');
    
    if (player.isPlaying) {
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
    } else {
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
    }
}

// Play Previous
function playPrevious() {
    if (player.currentTrackIndex > 0) {
        loadTrack(player.currentTrackIndex - 1);
        if (player.isPlaying) {
            player.audio.play();
        }
    }
}

// Play Next
function playNext() {
    let nextIndex;
    
    if (player.isShuffle) {
        // Random track (but not current)
        do {
            nextIndex = Math.floor(Math.random() * player.tracks.length);
        } while (nextIndex === player.currentTrackIndex && player.tracks.length > 1);
    } else {
        nextIndex = player.currentTrackIndex + 1;
        if (nextIndex >= player.tracks.length) {
            if (player.repeatMode === 1) {
                nextIndex = 0; // Loop to first track
            } else {
                return; // End of playlist
            }
        }
    }
    
    loadTrack(nextIndex);
    if (player.isPlaying) {
        player.audio.play();
    }
}

// Handle Track End
function handleTrackEnd() {
    if (player.repeatMode === 2) {
        // Repeat current track
        player.audio.currentTime = 0;
        player.audio.play();
    } else {
        playNext();
    }
}

// Toggle Shuffle
function toggleShuffle() {
    player.isShuffle = !player.isShuffle;
    shuffleBtn.classList.toggle('active', player.isShuffle);
}

// Toggle Repeat
function toggleRepeat() {
    player.repeatMode = (player.repeatMode + 1) % 3;
    const repeatOne = repeatBtn.querySelector('.repeat-one');
    
    switch(player.repeatMode) {
        case 0: // No repeat
            repeatBtn.classList.remove('active');
            repeatOne.classList.add('hidden');
            break;
        case 1: // Repeat all
            repeatBtn.classList.add('active');
            repeatOne.classList.add('hidden');
            break;
        case 2: // Repeat one
            repeatBtn.classList.add('active');
            repeatOne.classList.remove('hidden');
            break;
    }
}

// Volume Control
function changeVolume(e) {
    const volume = e.target.value / 100;
    player.audio.volume = volume;
    player.volume = volume;
    updateVolumeUI();
}

function toggleMute() {
    if (player.audio.volume > 0) {
        player.audio.volume = 0;
        updateVolumeUI();
    } else {
        player.audio.volume = player.volume;
        updateVolumeUI();
    }
}

function updateVolumeUI() {
    const volumePercent = player.audio.volume * 100;
    volumeSlider.value = volumePercent;
    volumeFill.style.width = volumePercent + '%';
    
    const volumeIcon = volumeBtn.querySelector('.volume-icon');
    const muteIcon = volumeBtn.querySelector('.mute-icon');
    
    if (player.audio.volume === 0) {
        volumeIcon.classList.add('hidden');
        muteIcon.classList.remove('hidden');
    } else {
        volumeIcon.classList.remove('hidden');
        muteIcon.classList.add('hidden');
    }
}

// Progress Bar
function updateProgress() {
    if (!player.audio.duration) return;
    
    const percent = (player.audio.currentTime / player.audio.duration) * 100;
    progressFill.style.width = percent + '%';
    progressHandle.style.left = percent + '%';
    
    currentTime.textContent = formatTime(player.audio.currentTime);
}

function updateDuration() {
    totalTime.textContent = formatTime(player.audio.duration);
}

function seek(e) {
    if (!player.audio.duration) return;
    
    const rect = progressBar.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    player.audio.currentTime = percent * player.audio.duration;
}

// Format Time
function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Keyboard Shortcuts
function handleKeyboard(e) {
    switch(e.code) {
        case 'Space':
            e.preventDefault();
            togglePlay();
            break;
        case 'ArrowLeft':
            e.preventDefault();
            player.audio.currentTime = Math.max(0, player.audio.currentTime - 5);
            break;
        case 'ArrowRight':
            e.preventDefault();
            player.audio.currentTime = Math.min(player.audio.duration, player.audio.currentTime + 5);
            break;
        case 'ArrowUp':
            e.preventDefault();
            player.audio.volume = Math.min(1, player.audio.volume + 0.1);
            player.volume = player.audio.volume;
            updateVolumeUI();
            break;
        case 'ArrowDown':
            e.preventDefault();
            player.audio.volume = Math.max(0, player.audio.volume - 0.1);
            player.volume = player.audio.volume;
            updateVolumeUI();
            break;
        case 'KeyM':
            e.preventDefault();
            toggleMute();
            break;
        case 'KeyN':
            e.preventDefault();
            playNext();
            break;
        case 'KeyP':
            e.preventDefault();
            playPrevious();
            break;
        case 'KeyS':
            e.preventDefault();
            toggleShuffle();
            break;
        case 'KeyR':
            e.preventDefault();
            toggleRepeat();
            break;
    }
}

// Progress Bar Drag
let isDragging = false;

progressBar.addEventListener('mousedown', (e) => {
    isDragging = true;
    seek(e);
});

document.addEventListener('mousemove', (e) => {
    if (isDragging) {
        seek(e);
    }
});

document.addEventListener('mouseup', () => {
    isDragging = false;
});

// Initialize on load
document.addEventListener('DOMContentLoaded', init);
